var DesignerInsertTemp={fileType:"",init:function(e){var t=this;if(t.fileType=e,"uncategorized"==cateType&&(cateType="flow"),"mind"==e&&"outline"!=cateType)t.renderBottomTemp(cateType);else{if("flow"!=e)return;t.renderBottomTemp()}setTimeout(function(){t.model.getIsmember.call(t)},3e3)},renderBottomTemp:function(){if(!(0<$(".bottom_temp_wrap").length)){var d=this;$(".bottom_temp_wrap").remove();var e=$("<div class='bottom_temp_wrap'></div>").appendTo("body");"mind"==d.fileType&&e.addClass("bottom_temp_wrap_mind"),d.fileType,e.append("<p class='title'>直接新建 或者选择一个模板</p>");var p=$("<div class='bottom_temp_box'></div>").appendTo(e);$(".bottom_temp_wrap").css("display","none"),0<d.model.markTemplates.length?a(d.model.markTemplates):$.ajax({url:"/templates/official_mark_templates",data:{category:cateType},success:function(e){d.model.markTemplates=e.templates,a(d.model.markTemplates)}});var t=$(window).width(),m=parseInt(t/170);p.off().on("click",function(e){e.stopPropagation();var t=$(e.target).parents(".item_box");if(0!=t.length){var a=t.attr("tempid"),i=t.attr("price");"mind"==d.fileType?a?d.mindInsert(a,i):d.renderDlgTemp():a?d.flowInsert(a,i):d.renderDlgTemp()}}),$("<div class='close'></div>").appendTo(e).off().on("click",function(){d.clear(),sessionStorage.setItem("temp_topic_len","true")}),p.on("mousedown",function(e){e.stopPropagation()})}function a(e){0==e.length&&$(".bottom_temp_wrap").remove(),$(".bottom_temp_wrap").css("display","block");for(var t="",a="",i=150,s=0;s<e.length;s++){var n=e[s];if(s<7){var o="";"public"===n.status&&!0===n.publicClone&&0<n.publicClonePrice&&null===n.owner?o+="<span class='iconVip'>vip免费</span>":o="";var c="temp_show";m-2<s?c="temp_hide":i+=170,"flow"==d.fileType&&(c=""),t+="<div class='item_box "+c+"' price="+n.publicClonePrice+" tempid='"+n.chartId+"'><div class='img_box'>"+o+"<img src='https://img.processon.com/chart_image/thumb/"+n.thumbnail+".png'/></div><div class='item_tit'>"+n.title+"</div></div>"}else 7<=s&&s<11&&(a+="<img class='more_img' src='https://img.processon.com/chart_image/thumb/"+n.thumbnail+".png'/>")}if(t+="<div class='item_box more_item_box'><div class='img_box' style='padding:5px;width:120px;height:120px;'>"+a+"</div><div class='item_tit'>更多模板</div></div>",p.html(t),$(".bottom_temp_wrap_mind").css("margin-left",-i/2+"px"),"flow"==d.fileType){var l=p.width()+100,r=parseInt(l/170);p.children(".item_box").each(function(e,t){e<r-1||7==e?$(t).addClass("temp_show"):$(t).addClass("temp_hide"),$(t).hasClass("more_item_box")&&$(t).addClass("temp_show")})}}},renderDlgTemp:function(){this.dlgTempCode.init()},dlgTempCode:{data:{collectionLoding:!1,collectionChartId:{},listStatus:1,tagName:"",searchPage:1,searchPageSize:15,isTempLoading:!1,scrollEnd:!1,tempCustData:[],isMind:!1,categoryIndex:0},init:function(){this.initData(),this.initTempData()},destory:function(e){e.find("*").remove()},initData:function(){this.data.isMind="undefined"!=typeof mind;DesignerInsertTemp.model.popData.categoryName="undefined"!=typeof cateType?cateType:"flow";var e=DesignerInsertTemp.model.popData;DesignerInsertTemp.model.popData.categoryIndex=0,this.data.isMind?$(e.categoryListB).each(function(e,t){if(t.dataCategory===DesignerInsertTemp.model.popData.categoryName)return DesignerInsertTemp.model.popData.categoryIndex=e,!0}):$(e.categoryList).each(function(e,t){if(t.dataCategory===DesignerInsertTemp.model.popData.categoryName)return DesignerInsertTemp.model.popData.categoryIndex=e,!0}),DesignerInsertTemp.model.popData.leftMenuIndex=0,this.data.listStatus=1,this.data.searchPage=1,this.data.isTempLoading=!1},newFile:function(t){Util.checkFileCount(function(e){0==e&&(t="/upgrade"),window.location.href=t})},initTempData:function(e){var o=this,t=DesignerInsertTemp.model.popData,a=DesignerInsertTemp.model.popData.categoryIndex,s=$("<div id='dlg_temp' class='dialog-win dialog dialog-box mind-dlg' style='z-index: 11;'><h3></h3><div class='dlg-content'></div></div>").appendTo("body"),i='<div class="dlgTempBox" id="dlgTempBox" >'+"<div class='dlg_temp_left'><h4 class='dialog-title'>去往模板首页 <span class='goToTemp icons'>&#xe7d0;</span></h4><ul class='left_bar' id='dlg_left_bar'>";t.leftMenuList=[];for(var n=t.leftMenuList,c=0,l=n.length;c<l;c++){i+="<li class='"+(c===t.leftMenuIndex?"active":"")+"'>"+n[c].name+"</li>"}if(i+="</ul><div class='icons custom customed dlg_btn'>更多场景定制&nbsp;<span class='icons'>&#xe688;</span></div><div class='icons custom collect dlg_btn' id='dlgCustomBtn'>收藏、关注的模板</div></div>",i+="<div class='dlg_temp_right'>",i+="<div class='searchBox'><span class='icons'>&#xe713;</span><input name='tempSearch' placeholder='搜索模版' id='tempSearch' type='text' /></div>",i+="<ul class='dlg_temp_top' id='dlg_categoryList'>",o.data.isMind)r=t.categoryListB;else var r=t.categoryList;for(c=0,l=r.length;c<l;c++){i+="<li class='"+(c===a?"active":"")+"' _category='"+r[c].dataCategory+"'><span class='icons'>"+r[c].icon+"</span><span class='name'>"+r[c].name+"</span></li>"}i+="</ul>",i+="<ul class='dlg_temp_top myCollection' id='dlg_myCollection'>";var d=t.myCollection;for(c=0,l=d.length;c<l;c++){i+="<li class='"+(0===c?"active":"")+"' _category='"+d[c].dataCategory+"'><span class='icons'>"+d[c].icon+"</span><span class='name'>"+d[c].name+"</span></li>"}i+="</ul>",i+="<div class='dlg_temp_con' id='dlg_temp_con'>",i+="<div class='temp_con_wrap' id='temp_con_wrap'></div>",i+='<div class="loading"><img src="/assets/images/new/loading.gif">加载中...</div>',i+='<span class="loadtip" style="display: none;">所有模板已经加载完毕</span>',i+='<div class="notemp" style="display: none;"><span class="notemp-icon"><img src="/assets/images/new/empty.png"><br>夜以继日更新模板中...</span></div>',i+="</div></div>",s.children(".dlg-content").append(i),this.bindEventTemp(s),this.getUserCustomTags(function(e){DesignerInsertTemp.model.popData.leftMenuList=e.tags,$.extend(o.data.tempCustData,e.tags);var t,a,i='<li class="active">为你推荐</li>';$(e.tags).each(function(e,t){i+="<li class='"+(0===e+1?"active":"")+"'>"+t+"</li>"}),$(".left_bar").html(i),t=DesignerInsertTemp.model.popData.leftMenuList,a='<div class="customized" id="dlgCustomized">',a+='<h2 class="dialog-title"><span class="goback icons">&#xe74f;</span>Hi, 为你定制专属内容推荐</h2>',a+='<span class="des"> 选择5个以上标签，推荐更精准 </span>',a+='<div class="custom-content">',a+="</div>",a+='<div class="bot-line">',a+='<div class="dlg-buttons">',a+='<span class="call">更多场景需求，请<a target="_blank" href="http://mzz479f6oqxzaeds.mikecrm.com/BOtrbmT" >告知我们</a ></span>',a+='<span class="pro-btn default custom-btn btn">已选'+t.length+"个</span>",a+="</div>",a+="</div>",a+="</div>",s.children(".dlg-content").append(a),o.getOfficialTags(function(e){var n="";$(e.categories).each(function(e,s){n+='<div class="type">'+s.name+"</div>",0<s.tagNames.length&&(n+="<ul>",$(s.tagNames).each(function(e,t){var a=s.tagIds,i=o.checkCustomizationActive(t)?"active":"";n+='<li class="'+i+'" data-tagIds="'+a[e]+'" data-parent="'+s.name+'">'+t+"</li>"}),n+="</ul>")}),$("#dlgCustomized .custom-content").html(n),o.bindEventCustomization()})}),this.changeCategoryDataList()},bindEventTemp:function(o){var c=this;o.find(".goToTemp,.dialog-title").off("click").on("click",function(e){window.location.href="/diagrams/new#template"}),o.find(".left_bar").off("click").on("click","li",function(e){$(this).addClass("active").siblings("li").removeClass("active"),o.find(".collect").removeClass("active"),$("#dlg_myCollection").hide(),$("#dlg_categoryList").show(),c.data.scrollEnd=!1,DesignerInsertTemp.model.popData.leftMenuIndex=$(this).index();var t=$.trim($(this).text());0===$(this).index()?c.data.listStatus=1:(c.data.listStatus=2,c.data.searchPage=1),c.data.tagName=t,c.changeCategoryDataList()}),o.find(".customed").off("click").bind("click",function(e){c.changeDlgPage("customized")}),$("#dlgCustomBtn").off("click").bind("click",function(e){$(this).addClass("active"),$("#dlg_left_bar li").removeClass("active"),$("#dlg_myCollection").show(),$("#dlg_categoryList").hide(),$("#dlg_myCollection li").eq(0).trigger("click")}),$("#dlg_myCollection li").off("click").bind("click",function(e){$(this).addClass("active").siblings("li").removeClass("active");$(this).index();var t=$(this).attr("_category");c.changeMyCollection(t)}),$("#dlg_categoryList li").off("click").bind("click",function(e){$(this).addClass("active").siblings("li").removeClass("active"),DesignerInsertTemp.model.popData.categoryName=$(this).attr("_category"),c.data.searchPage=1,c.data.scrollEnd=!1,DesignerInsertTemp.model.popData.categoryIndex=$(this).index(),c.changeCategoryDataList()}),$("#temp_con_wrap").off("click").on("click",".item_box",function(e){var t=$(this).attr("_etype"),a=$(this).attr("_price"),i=$(this);if("setFlow"!==$(e.target).attr("_etype")&&"iconCollection"!==$(e.target).attr("class")||(t="setFlow"),$(e.target).attr("_etype"))switch($(e.target).attr("_etype")){case"preview":t="preview";break;case"setFlow":t="setFlow"}var s=$(this).attr("tempid");switch(t){case"plus":var n=$("#dlg_categoryList .active").attr("_category");n==cateType?o.find(".dialog-close,.mind-dlog-close").trigger("click"):(o.find(".dialog-close,.mind-dlog-close").trigger("click"),-1<n.indexOf("mind")?c.newFile("/mindmap/new?category="+n):c.newFile("/diagraming/new?category="+n));break;case"item":c.addTemp(s,a,o);break;case"setFlow":c.setToFollow(function(e){"save"===e.result?(i.children(".iconCollection").find("i").eq(1).show(),i.children(".iconCollection").find("i").eq(0).hide()):(i.children(".iconCollection").find("i").eq(0).show(),i.children(".iconCollection").find("i").eq(1).hide()),poCollect("编辑器-模板弹窗收藏",{"收藏":"save"===e.result?"收藏":"取消"})},s);break;case"preview":c.toPreview(s)}}),$("#temp_con_wrap").on("click",".user-info",function(t){switch($(t.target).attr("_etype")){case"myflow":var e=$(t.target).parent("span.name").attr("_userId"),a=!1;"1"!==$(t.target).attr("_isflow")?(a=!0,c.setMyFlow(function(e){$(t.target).hide().siblings("i.autoPlus").show()},e,a)):c.setMyFlow(function(e){$(t.target).hide().siblings("i.autoPlus").show()},e,a)}}),$(".dialog-title").off("mouseenter").on("mouseenter",function(e){$(this).children("span").addClass("anmAutoLR")}),$(".dialog-title").off("mouseleave").on("mouseleave",function(e){$(this).children("span").removeClass("anmAutoLR")}),$("#temp_con_wrap").off("mouseenter").on("mouseenter",".item_box",function(e){var t=$(this).attr("tempid"),a=$(this).attr("isliked"),i=$(this);if(i.children(".iconCollection").css("display","flex"),a)return!1;c.checkTemp(t,function(e){e.liked?i.children(".iconCollection").find("i").eq(1).show().siblings("i").hide():i.children(".iconCollection").find("i").eq(0).show().siblings("i").hide(),i.attr("isliked","1")})}),$("#temp_con_wrap").off("mouseleave").on("mouseleave",".item_box",function(e){$(this).children(".iconCollection").hide()}),$("#tempSearch").off().bind("keyup",function(e){localStorage.setItem("keyword",$(this).val()),13===e.keyCode&&(window.location.href="/diagrams/new#template")}),$("#tempSearch").siblings("span.icons").off("click").bind("click",function(){localStorage.setItem("keyword",$("#tempSearch").val()),window.location.href="/diagrams/new#template"}),$("#dlg_temp_con").off("scroll").bind("scroll",function(){2!==c.data.listStatus||c.data.isTempLoading||c.data.scrollEnd||$(this).scrollTop()+$(this).height()>=$("#temp_con_wrap").height()&&(c.data.searchPage++,c.changeCategoryDataList("add"))}),o.dialog({onClose:function(){c.destory(o),o.remove()}}),$(window).height()<800&&("mind"==DesignerInsertTemp.fileType?o.css("transform","translate(-50%, -50%) scale(.9)"):o.css("transform","translate(-50%, 0) scale(.9)"))},bindEventCustomization:function(e){var i=this;$("#dlgCustomized").find(".goback").off("click").bind("click",function(e){i.changeDlgPage("temp",!1)}),$("#dlgCustomized .custom-content").find("li").off("click").bind("click",function(e){var t;t=!$(this).hasClass("active");var a=i.changeTempCustData($.trim($(this).text()),t);$("#dlgCustomized").find(".pro-btn").html("已选"+a.length+"个"),$(this).toggleClass("active")}),$("#dlgCustomized").find(".pro-btn").off().bind("click",function(e){i.toSaveCustomTags(function(e){DesignerInsertTemp.model.popData.leftMenuList=[],$.extend(DesignerInsertTemp.model.popData.leftMenuList,i.data.tempCustData),i.changeLeftTempCust(),i.changeDlgPage("temp",!0)})})},changeLeftTempCust:function(){var e=DesignerInsertTemp.model.popData.leftMenuList,a='<li class="active">为你推荐</li>';$(e).each(function(e,t){a+="<li class='"+(0===e+1?"active":"")+"'>"+t+"</li>"}),$(".left_bar").html(a)},changeTempCustData:function(e,t){var a=this;if(t)a.data.tempCustData.push(e);else for(var i=0,s=a.data.tempCustData.length;i<s;i++)if(a.data.tempCustData[i]===e){a.data.tempCustData.splice(i,1);break}return a.data.tempCustData},toPreview:function(e){window.open("/view/"+e)},addTemp:function(e,t,a){a.find(".dialog-close,.mind-dlog-close").trigger("click"),"a"===this.getPageType()?DesignerInsertTemp.flowInsert(e,t):DesignerInsertTemp.mindInsert(e,t)},getPageType:function(){for(var e=DesignerInsertTemp.model.popData.categoryList,t=DesignerInsertTemp.model.popData.categoryListB,a="",i=0,s=e.length;i<s;i++)if(e[i].dataCategory===DesignerInsertTemp.model.popData.categoryName){a="a";break}for(i=0,s=t.length;i<s;i++)if(t[i].dataCategory===DesignerInsertTemp.model.popData.categoryName){a="b";break}return a},checkData:function(e){var a=[],i=this;return $(e).each(function(e,t){i.checkItemShow(t.category)&&a.push(t)}),a},checkItemShow:function(e){var t=!1;return e&&"outline"!==e?t=this.data.isMind?-1<e.indexOf("mind"):-1===e.indexOf("mind")&&"outline"!==e:t},changeMyCollection:function(e){switch(e){case"myused":this.data.listStatus=3,this.changeCategoryDataList();break;case"myCollection":this.data.listStatus=4,this.changeCategoryDataList();break;case"myfollow":this.data.listStatus=5,this.changeCategoryDataList()}},changeDlgPage:function(e,t){switch(e){case"temp":$("#dlgTempBox").css({opacity:1,transform:"translateX(0px)"}),$("#dlgCustomized").css({opacity:1,transform:"translateX(980px)"}),"boolean"==typeof t&&!0===t&&(this.data.searchPage=1,3===this.data.listStatus||4===this.data.listStatus||5===this.data.listStatus||(this.data.listStatus=1,$("#dlg_myCollection").hide(),$("#dlg_categoryList").show()),$("#dlgCustomBtn").removeClass("active"),this.changeCategoryDataList());break;case"customized":$("#dlgTempBox").css({opacity:.1,transform:"translateX(-980px)"}),$("#dlgCustomized").css({opacity:1,transform:"translateX(0px)"})}},changeCategoryDataList:function(a){var o=this;switch("add"!==a&&$("#temp_con_wrap").hide(),$("#temp_con_wrap").next(".loading").css("display","flex"),$("#dlg_temp_con").find(".loadtip").hide(),o.data.isTempLoading=!0,o.data.listStatus){case 1:this.getTempData(function(e){i(e)});break;case 2:var e={category:DesignerInsertTemp.model.popData.categoryName,page:o.data.searchPage,rows:o.data.searchPageSize,tag:o.data.tagName};this.getSearchTemp(e,function(e){$("#temp_con_wrap").next(".loading").hide(),e.rows.length<=0&&(o.data.scrollEnd=!0,$("#dlg_temp_con").find(".loadtip").show()),i(e.rows)});break;case 3:this.getLastUsed(function(e){var t=e.rows;i(o.checkData(t))});break;case 4:this.getMyLoadfiles(function(e){var t=e.charts;i(o.checkData(t))});break;case 5:this.getMyNewFollowTemplates(function(e){!function(e){var s='<ul class="temp-tag-list manage" style="height: auto">';$(e).each(function(e,t){var a=o.checkData(t.templates);if(a.length<=0)return!0;s+='<li class="temp-item-user" userid="'+t.userId+'">',s+='<div class="user-info">',s+='<span class="face"><a class="" href="/u/'+t.userName+'" target="_blank">',t.isTalent&&(s+='<img class="dr"/ src="https://www.processon.com/assets/images/new/talent_lab.svg">'),s+='<img src="/photo/'+t.userId+'.png"/>',s+="</a></span>",s+='<div class="userInfo">',s+='<span class="name" _userId="'+t.userId+'"><a href="/u/'+t.userId+'" target="_blank">'+t.fullName+"</a>",t.isFlow?s+='<i class="icons autoPlus" title="已关注" _isflow="1" _etype="myflow">&#xe75b;</i><i class="icons noflow autoPlus" title="未关注" _isflow="2" _etype="myflow" style="display:none;">&#xe640;</i>':s+='<i class="icons autoPlus" title="已关注" _isflow="1" _etype="myflow" style="display:none;">&#xe75b;</i><i class="icons noflow autoPlus" title="未关注" _isflow="2" _etype="myflow" >&#xe640;</i>',s+="</span>",s+='<span class="intro">'+(""==t.introduction?"这个人很懒，什么都没留下":t.introduction)+"</span>",s+='<div class="btn-group">',s+='<span class="sub"></span>',s+='<a href="/u/'+t.userName+'" target="_blank">模板：<span>'+t.templateTotal+"</span></a>",s+='<a href="/u/'+t.userName+'" target="_blank">粉丝：<span>'+t.flowMes+"</span></a>",s+="</div>",s+="</div>",s+="</div>",s+='<div class="file-list">',$(a).each(function(e,t){if(3<=e)return!1;if(!o.checkItemShow(t.category))return!1;s+="<div class='item_box' tempid='"+t.chartId+"' _price='"+t.publicClonePrice+"' _etype='item'><div class='img_box'><img src='https://img.processon.com/chart_image/thumb/"+t.thumbnail+".png'/></div>","public"===t.status&&!0===t.publicClone&&0<t.publicClonePrice&&(void 0!==t.ownerId&&null!==t.ownerId||(s+="<span class='iconVip'>vip免费</span>")),s+="<span class='iconCollection'><i class='icons' _etype='setFlow'>&#xe7dc;</i><i class='icons' _etype='setFlow' style='display:none;'>&#xe7e0;</i> 收藏</span>",s+="<div class='itemMask' _etype='item'><a class='btn btnView' _etype='preview'>预览</a><a class='btn btnToUse' _etype='item'>使用</a></div>",s+="<div class='item_titBox'><div class='item_tit'>"+t.title+"</div>";var a="免费",i="gratis";"public"===t.status&&!0===t.publicClone&&0<t.publicClonePrice&&(a="￥"+t.publicClonePrice,i="price"),s+="<span class='priceInfo "+i+"'>"+a+"</span>",s+="</div></div>"}),s+="</div>",s+="</li>"}),s+="</ul>",$("#temp_con_wrap").show().html(s),$("#temp_con_wrap .temp-tag-list li.temp-item-user").length<=0&&(e=[]);$("#temp_con_wrap").next(".loading").hide(),e.length<=0&&($("#dlg_temp_con").find(".notemp").show(),$("#dlg_temp_con").find(".loadtip").hide());o.data.isTempLoading=!1}(e.followUserArray)})}function i(e){var t=DesignerInsertTemp.model.popData.categoryListData=e,n="<div class='item_box btnItemPlus' _etype='plus'><span class='icons'>&#xe602;</span><span class='info'>新建"+(o.data.isMind?DesignerInsertTemp.model.popData.categoryListB[DesignerInsertTemp.model.popData.categoryIndex].name:DesignerInsertTemp.model.popData.categoryList[DesignerInsertTemp.model.popData.categoryIndex].name)+"</span></div>";if("add"===a&&0<$("#temp_con_wrap .item_box").length||3===o.data.listStatus||4===o.data.listStatus)n="";$(t).each(function(e,t){var a=t;if(!o.checkItemShow(t.category))return!1;n+="<div class='item_box' tempid='"+a.chartId+"' _price='"+a.publicClonePrice+"' _etype='item'><div class='img_box'><img src='https://img.processon.com/chart_image/thumb/"+a.thumbnail+".png?cid="+a.chartId+"'/></div>","public"===t.status&&!0===t.publicClone&&0<t.publicClonePrice&&(1===o.data.listStatus||3===o.data.listStatus||4===o.data.listStatus?void 0!==t.owner&&null!==t.owner||(n+="<span class='iconVip'>vip免费</span>"):void 0!==t.ownerId&&null!==t.ownerId||(n+="<span class='iconVip'>vip免费</span>")),n+="<span class='iconCollection'><i class='icons' _etype='setFlow'>&#xe7dc;</i><i class='icons' _etype='setFlow' style='display:none;'>&#xe7e0;</i> 收藏</span>",n+="<div class='itemMask' _etype='item'><a class='btn btnView' _etype='preview'>预览</a><a class='btn btnToUse' _etype='item'>使用</a></div>",n+="<div class='item_titBox'><div class='item_tit'>"+a.title+"</div>";var i="免费",s="gratis";"public"===t.status&&!0===t.publicClone&&0<t.publicClonePrice&&(i="￥"+t.publicClonePrice,s="price"),n+="<span class='priceInfo "+s+"'>"+i+"</span>",n+="</div></div>"}),"add"===a?$("#temp_con_wrap").append(n):($("#temp_con_wrap").html(n),$("#temp_con_wrap").show(),e.length<=0&&($("#dlg_temp_con").find(".notemp").show(),$("#dlg_temp_con").find(".loadtip").hide())),0<e.length&&$("#dlg_temp_con").find(".notemp").hide(),$("#temp_con_wrap").next(".loading").hide(),o.data.isTempLoading=!1}},checkCustomizationActive:function(a){var e=DesignerInsertTemp.model.popData.leftMenuList,i=!1;return $(e).each(function(e,t){if(t===a)return i=!0}),i},getTempData:function(t){var e=DesignerInsertTemp.model.popData.categoryName;$.ajax({type:"GET",url:"/templates/official_mark_templates",data:"category="+e,success:function(e){if("success"!==e.result)return!1;"function"==typeof t&&t(e.templates)}})},getSearchTemp:function(e,t){var a={category:e.category,page:e.page,rows:e.rows,tag:e.tag,sidx:"cloneCount"};$.ajax({type:"POST",url:"/search/template",data:JSON.stringify(a),contentType:"application/json",success:function(e){if(e.result&&"error"===e.result)return!1;"function"==typeof t&&t(e)}})},getUserCustomTags:function(t){$.ajax({type:"GET",url:"/templates/user_custom_tags",data:"",success:function(e){if("success"!==e.result)return!1;"function"==typeof t&&t(e)}})},checkTemp:function(e,t){var a=this;if(this.data.collectionLoding)return!1;this.data.collectionLoding=!0,$.ajax({type:"GET",url:"/templates/"+e+"/liked",data:"",success:function(e){if("success"!==e.result)return!1;"function"==typeof t&&t(e),a.data.collectionLoding=!1}})},getOfficialTags:function(t){$.ajax({type:"GET",url:"/templates/official_categories",data:"",success:function(e){if("success"!==e.result)return!1;"function"==typeof t&&t(e)}})},toSaveCustomTags:function(t){var e={tagName:this.data.tempCustData.toString()};$.ajax({type:"POST",url:"/templates/save_custom_tags",data:e,success:function(e){if("success"!==e.result)return!1;"function"==typeof t&&t(e)}})},getMyNewFollowTemplates:function(t,e){var a={sort:"string"==typeof e?srot:"publishTime"};$.ajax({type:"POST",url:"/templates/new_follow_templates",data:a,success:function(e){if("success"!==e.result)return!1;"function"==typeof t&&t(e)}})},getMyLoadfiles:function(t){$.ajax({type:"POST",url:"/folder/loadfiles",data:{resource:"fav",page:1},success:function(e){if("success"!==e.result)return!1;"function"==typeof t&&t(e)}})},getLastUsed:function(t){$.ajax({type:"POST",url:"/folder/template_used",data:{resource:"fav",page:1},success:function(e){"function"==typeof t&&t(e)}})},setToFollow:function(t,e){var a={chartId:e};$.ajax({type:"GET",url:"/view/favouriteChart",data:a,success:function(e){"function"==typeof t&&t(e)}})},setMyFlow:function(t,e,a){var i={};i=a?{followIds:e}:{followId:e},$.ajax({type:"GET",url:a?"/start/savefollow":"/start/unfollow",data:i,success:function(e){if("success"!==e.result)return!1;"function"==typeof t&&t(e)}})}},clear:function(){$(".bottom_temp_wrap").remove(),$("#dlg_temp").remove()},flowInsert:function(c,l,e){var r=this,t=r.model.getTemplatesById(c),d=r.model.getCategoryListByName(cateType),p=null;t&&(p=r.model.getCategoryListByName(t.category)),$.post("/templates/insert_official_mark_template",{chartId:c},function(e){if("order_error"==e.result)poCollect("编辑器-模板支付弹窗",{"文件类型":d?d.name:"空","模板分类":p?p.name:"空","模板id":c,"模板价格":l,"用户属性":r.model.ismember?"会员用户":"普通用户"}),Util.payWindow("open",{chartId:c,price:l,type:"designer"},function(e){"close"==e?"undefined"!=typeof checkWxOrderTimer&&clearInterval(checkWxOrderTimer):"success"==e&&(poCollect("编辑器-模板支付成功",{"文件类型":d?d.name:"空","模板分类":p?p.name:"空","模板id":c,"模板价格":l,"用户属性":r.model.ismember?"会员用户":"普通用户"}),Util.payWindow("close"),r.flowInsert(c,l))});else{if("success"!=e.result)return void Util.globalTopTip(e.msg,"top_error",3e3,$("#designer"),!0);poCollect("编辑器-模板使用",{"文件类型":d?d.name:"空","模板分类":p?p.name:"空","模板id":c,"模板价格":l,"用户属性":r.model.ismember?"会员用户":"普通用户"});var t=JSON.parse(e.def).elements,a=[],i=[];MessageSource.beginBatch(),r.model.presetIds(t);r.model.presetedIds;for(var s in t){"linker"!=(n=t[s]).name&&(Schema.initShapeFunctions(n),Designer.painter.renderShape(n),i.push(n),a.push(n.id))}for(var s in t){var n;"linker"==(n=t[s]).name&&(Designer.painter.renderLinker(n),i.push(n),a.push(n.id))}Model.addMulti(i,!0,c);var o=Utils.getControlBox(a);Designer.op.changeCanvas(o),MessageSource.commit(),p.dataCategory!=cateType&&DesignerInsertTemp.model.updataCataType(p.dataCategory,function(){})}})},mindInsert:function(a,i){var s=this;$.post("/templates/insert_official_mark_template",{chartId:a},function(e){if("order_error"==e.result)Util.payWindow("open",{chartId:a,price:i,type:"designer"},function(e){"close"==e?"undefined"!=typeof checkWxOrderTimer&&clearInterval(checkWxOrderTimer):"success"==e&&(Util.payWindow("close"),s.mindInsert(a,i))});else{if("success"!=e.result)return void $.showTip(e.msg,3e3);poCollect("编辑器-模板使用",{"文件类型":"思维导图","模板id":a,"模板价格":i,"用户属性":s.model.ismember?"会员用户":"普通用户"});var t=JSON.parse(e.def);mind.operation.insertTemp.call(mind,t,null,a)}})},model:{popData:{leftMenuIndex:0,leftMenuList:[],categoryName:"flow",categoryListData:[],categoryIndex:0,categoryList:[{name:"流程图",icon:"&#xe6bb;",dataCategory:"flow"},{name:"原型图",icon:"&#xe6c1;",dataCategory:"ui"},{name:"组织结构-流程图",icon:"&#xe7f6;",dataCategory:"org"},{name:"UML",icon:"&#xe6bd;",dataCategory:"uml"},{name:"BPMN",icon:"&#xe6c2;",dataCategory:"bpmn"},{name:"网络拓扑图",icon:"&#xe6be;",dataCategory:"network"},{name:"Venn韦恩图",icon:"&#xe6c6;",dataCategory:"venn"},{name:"EVC企业价值链",icon:"&#xe7f2;",dataCategory:"evc"},{name:"EPC事件过程链图",icon:"&#xe6c5;",dataCategory:"epc"},{name:"魏朱商业模式",icon:"&#xe6c8;",dataCategory:"weizhu_bm"}],categoryListB:[{name:"思维导图",icon:"&#xe7f4;",dataCategory:"mind_free"},{name:"组织结构-树状图",icon:"&#xe7f9;",dataCategory:"mind_org"}],myCollection:[{name:"最近使用",icon:"&#xe7dc;",dataCategory:"myused"},{name:"我的收藏",icon:"&#xe70a;",dataCategory:"myCollection"},{name:"我的关注",icon:"&#xe6a5;",dataCategory:"myfollow"}]},markTemplates:[],presetedIds:{},presetIds:function(e){for(key in this.presetedIds={},e){var t=e[key];this.presetedIds[t.id]=Utils.newId(),t.group&&!this.presetedIds[t.group]&&(this.presetedIds[t.group]=Utils.newId())}},getTemplatesById:function(e){for(var t=this.markTemplates.concat(this.popData.categoryListData),a=null,i=0,s=t.length;i<s;i++){var n=t[i];if(n.id==e){a=n;break}}return a},getCategoryListByName:function(e){for(var t=this.popData.categoryList.concat(this.popData.categoryListB),a=null,i=0,s=t.length;i<s;i++){var n=t[i];if(n.dataCategory==e){a=n;break}}return a},ismember:!1,getIsmember:function(){var t=this;"mind"==t.fileType?t.model.ismember=mindUI.member:Designer.events.push("isMember",function(e){t.model.ismember=e})},updataCataType:function(e,t){cateType=e,this.updataSchameByCate(e,t)},updataSchameByCate:function(e,t){var a=this.cataSchameMap[e];if(a){var i={action:"changeSchema",categories:a.join(",")};CLB.send(i),Designer.setSchema(a,function(){"function"==typeof t&&t()})}else"function"==typeof t&&t("err")},cataSchameMap:{flow:["basic","flow","lane"],ui:["ui","ui_input"],uml:["basic","uml_common","uml_usecase","uml_sequence","uml_class","uml_stateactivity","uml_deployment","uml_component","er"],network:["basic","network"],bpmn:["basic","bpmn","lane"],org:["basic","org"],venn:["venn","basic"],evc:["standard","evc","basic"],epc:["standard","basic","epc","org","lane"],weizhu_bm:["weizhu_bm","basic","standard"]}}};